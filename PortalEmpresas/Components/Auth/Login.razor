@page "/login"
@attribute [AllowAnonymous]
@inject AuthStateProvider AuthState
@inject NavigationManager Nav
@using System.ComponentModel.DataAnnotations

<PageTitle>Portal Empresas - Login</PageTitle>

<MudPaper Class="min-h-screen flex items-center justify-center px-6 md:px-12 lg:px-24" Elevation="0">

    <MudPaper Class="w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden">

        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-10 py-14 text-center">            
            <MudText Typo="Typo.h4" Class="text-white font-semibold mb-1">Portal Empresas</MudText>
            <MudText Typo="Typo.subtitle2" Class="text-blue-200">Sistema de Gestión Empresarial</MudText>
        </div>

        <!-- Formulario -->
        <div class="px-10 py-12">
            <EditForm EditContext="@editContext" OnValidSubmit="HandleLogin">
                <DataAnnotationsValidator />

                <!-- RUT Empresa -->
                <MudTextField @bind-Value="loginModel.RutEmpresa"
                              Label="RUT Empresa"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              FullWidth="true"
                              Required="true"
                              Immediate="true"
                              Class="mb-6"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Business" />

                <ValidationMessage For="@(() => loginModel.RutEmpresa)" Class="text-red-600 text-sm mb-4" />

                <!-- Email -->
                <MudTextField @bind-Value="loginModel.Email"
                              Label="Correo Electrónico"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              FullWidth="true"
                              Required="true"
                              Immediate="true"
                              InputType="InputType.Email"
                              Class="mb-6"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email" />

                <ValidationMessage For="@(() => loginModel.Email)" Class="text-red-600 text-sm mb-4" />

                <!-- Password -->
                <MudTextField @bind-Value="loginModel.Password"
                              Label="Contraseña"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              FullWidth="true"
                              Required="true"
                              Immediate="true"
                              InputType="@(showPassword ? InputType.Text : InputType.Password)"
                              Class="mb-6"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Lock"
                              AdornmentEndIcon="@(showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                              OnAdornmentClick="@(() => showPassword = !showPassword)" />

                <ValidationMessage For="@(() => loginModel.Password)" Class="text-red-600 text-sm mb-4" />

                <!-- Recordarme -->
                <div class="flex items-center mb-8">
                    <MudCheckBox T="bool" @bind-Checked="loginModel.Recordar" Color="Color.Primary" Class="mr-2" />
                    <MudText Typo="Typo.body2" Class="select-none">Recordarme en este dispositivo</MudText>
                </div>

                <!-- Botón Login -->
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           Disabled="@(loading || !editContext.Validate())"                           
                           Class="py-3 font-semibold"
                           OnClick="HandleLogin">
                    @if (loading)
                    {
                        <MudProgressCircular Size="Size.Small" Color="Color.Inherit" Indeterminate="true" Class="mr-3" />
                        <p>Iniciando sesión...</p>
                    }
                    else
                    {
                        <p>Iniciar Sesión</p>
                    }
                </MudButton>
            </EditForm>
        </div>

        <!-- Footer demo -->
        <div class="bg-blue-50 border-t border-blue-200 px-10 py-6 text-sm text-blue-900">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="font-semibold mb-2">🔧 Credenciales de Demo:</p>
                <ul class="space-y-1">
                    <li><strong>RUT:</strong> <code class="bg-white px-2 py-1 rounded">76.123.456-7</code></li>
                    <li><strong>Email:</strong> <code class="bg-white px-2 py-1 rounded">admin@empresa.cl</code></li>
                    <li><strong>Password:</strong> <code class="bg-white px-2 py-1 rounded">123456</code></li>
                </ul>
            </div>
        </div>

    </MudPaper>
</MudPaper>

@code {
    private LoginModel loginModel = new();
    private bool loading = false;
    private bool showPassword = false;
    private EditContext editContext;

    protected override void OnInitialized()
    {
        editContext = new EditContext(loginModel);
    }

    private async Task HandleLogin()
    {
        if (!editContext.Validate())
            return;

        loading = true;
        StateHasChanged();

        // Simular llamada a backend o validación
        await Task.Delay(1500);

        if (loginModel.Password != "123456")
        {
            loading = false;
            StateHasChanged();
            // Aquí podrías mostrar mensaje de error
            return;
        }

        // Llama al SignIn para actualizar estado de autenticación
        AuthState.SignIn(loginModel.RutEmpresa, loginModel.Email);

        loading = false;

        Nav.NavigateTo("/");
    }


    public class LoginModel
    {
        [Required(ErrorMessage = "RUT empresa es requerido")]
        public string RutEmpresa { get; set; } = "";

        [Required(ErrorMessage = "Email es requerido")]
        [EmailAddress(ErrorMessage = "Email debe ser válido")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Contraseña es requerida")]
        [StringLength(50, MinimumLength = 6, ErrorMessage = "Contraseña debe tener entre 6 y 50 caracteres")]
        public string Password { get; set; } = "";

        public bool Recordar { get; set; }
    }
}
